<html><head><link rel='stylesheet' href='styles.css'></head><code><a style='color:violet;'>defmodule</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>LegacyHandler</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>  </a><a style='color:violet;'>import</a><a> </a><a style='color:gold;'>Kousa</a><a style='color:red;'>.</a><a style='color:gold;'>Utils</a><a style='color:red;'>.</a><a style='color:gold;'>Version</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>only:</a><a> </a><a style='color:red;'>[</a><a style='color:#2a6edb;'>sigil_v:</a><a> </a><a style='color:#2a6edb;'>2</a><a style='color:red;'>]</a><div>
</div><a>  </a><a style='color:violet;'>import</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>SocketHandler</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>only:</a><a> </a><a style='color:red;'>[</a><a style='color:#2a6edb;'>prepare_socket_msg:</a><a> </a><a style='color:#2a6edb;'>2</a><a style='color:red;'>]</a><div>
</div><a>  </a><a style='color:violet;'>require</a><a> </a><a style='color:gold;'>Logger</a><div>
</div><div>
</div><a>  </a><a style='color:gold;'>Kousa</a><a style='color:red;'>.</a><a style='color:gold;'>MixProject</a><a style='color:red;'>.</a><a style='color:sandybrown;'>project</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Keyword</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:version</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Version</a><a style='color:red;'>.</a><a style='color:sandybrown;'>parse!</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Version</a><a style='color:red;'>.</a><a style='color:sandybrown;'>compare</a><a style='color:red;'>(</a><a style='color:red;'>~</a><a style='color:sandybrown;'>v</a><a style='color:red;'>(</a><a style='color:#2a6edb'>0.3</a><a style='color:red;'>.</a><a style='color:#2a6edb;'>0</a><a style='color:red;'>)</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:red;'>|></a><a> </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:aquamarine;'>:lt</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><a> </a><a style='color:aquamarine;'>:ok</a><div>
</div><a>    </a><a style='color:grey;'>_</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><a> </a><a style='color:sandybrown;'>raise</a><a> </a><a style='color:gold;'>CompileError</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>message:</a><a> </a><a style='color:greenyellow;'>"this module should not exist beyond version 0.3.0"</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>process</a><a style='color:red;'>(</a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"op"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:greenyellow;'>"block_user_and_from_room"</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"d"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>block_user_and_from_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>process</a><a style='color:red;'>(</a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"op"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:greenyellow;'>"fetch_follow_list"</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"d"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>fetch_follow_list</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>process</a><a style='color:red;'>(</a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"op"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:greenyellow;'>"join_room_and_get_info"</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"d"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"fetchId"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>fetch_id</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>join_room_and_get_info</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>fetch_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'># legacy implementation special cases</a><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>block_user_and_from_room</a><a style='color:red;'>(</a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"userId"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>user_id_to_block</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>Logger</a><a style='color:red;'>.</a><a style='color:sandybrown;'>error</a><a style='color:red;'>(</a><div>
</div><a>      </a><a style='color:greenyellow;'>"block_user_and_from_room command is deprecated.  Send two user:block and room:ban operations instead"</a><div>
</div><a>    </a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:gold;'>Kousa</a><a style='color:red;'>.</a><a style='color:gold;'>UserBlock</a><a style='color:red;'>.</a><a style='color:sandybrown;'>block</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>user</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id_to_block</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:gold;'>Kousa</a><a style='color:red;'>.</a><a style='color:gold;'>Room</a><a style='color:red;'>.</a><a style='color:sandybrown;'>block_from_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>user</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id_to_block</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:#2a6edb;'>nil</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>fetch_follow_list</a><a style='color:red;'>(</a><div>
</div><a>         </a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"userId"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"isFollowing"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>get_following_list</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"cursor"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>cursor</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>         </a><a style='color:sandybrown;'>state</a><div>
</div><a>       </a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>nextCursor</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:gold;'>Kousa</a><a style='color:red;'>.</a><a style='color:gold;'>Follow</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get_follow_list</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>user</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>get_following_list</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>cursor</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>prepare_socket_msg</a><a style='color:red;'>(</a><div>
</div><a>      </a><a style='color:red;'>%{</a><div>
</div><a>        </a><a style='color:#2a6edb;'>op:</a><a> </a><a style='color:greenyellow;'>"fetch_follow_list_done"</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>d:</a><a> </a><a style='color:red;'>%{</a><div>
</div><a>          </a><a style='color:#2a6edb;'>isFollowing:</a><a> </a><a style='color:sandybrown;'>get_following_list</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>userId:</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>users:</a><a> </a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>nextCursor:</a><a> </a><a style='color:sandybrown;'>nextCursor</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>initial:</a><a> </a><a style='color:sandybrown;'>cursor</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:#2a6edb;'>0</a><div>
</div><a>        </a><a style='color:red;'>}</a><div>
</div><a>      </a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:sandybrown;'>state</a><div>
</div><a>    </a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>join_room_and_get_info</a><a style='color:red;'>(</a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"roomId"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>room_id_to_join</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>fetch_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>reply</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:gold;'>Kousa</a><a style='color:red;'>.</a><a style='color:gold;'>Room</a><a style='color:red;'>.</a><a style='color:sandybrown;'>join_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>user</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>room_id_to_join</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>        </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>error:</a><a> </a><a style='color:sandybrown;'>err</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>          </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>op:</a><a> </a><a style='color:greenyellow;'>"fetch_done"</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>d:</a><a> </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>error:</a><a> </a><a style='color:sandybrown;'>err</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>fetchId:</a><a> </a><a style='color:sandybrown;'>fetch_id</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>        </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>room:</a><a> </a><a style='color:sandybrown;'>room</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>          </a><a style='color:red;'>{</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>users</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Users</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get_users_in_current_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>user</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>          </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>RoomSession</a><a style='color:red;'>.</a><a style='color:sandybrown;'>lookup</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>            </a><a style='color:red;'>[</a><a style='color:red;'>]</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>              </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>op:</a><a> </a><a style='color:greenyellow;'>"error"</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>d:</a><a> </a><a style='color:greenyellow;'>"Room no longer exists."</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>            </a><a style='color:grey;'>_</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>              </a><a style='color:red;'>{</a><a style='color:sandybrown;'>muteMap</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>deafMap</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>autoSpeaker</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>activeSpeakerMap</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><div>
</div><a>                </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>RoomSession</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get_maps</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>              </a><a style='color:sandybrown;'>payload</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:red;'>%{</a><div>
</div><a>                </a><a style='color:#2a6edb;'>room:</a><a> </a><a style='color:sandybrown;'>room</a><a style='color:red;'>,</a><div>
</div><a>                </a><a style='color:#2a6edb;'>users:</a><a> </a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><div>
</div><a>                </a><a style='color:#2a6edb;'>muteMap:</a><a> </a><a style='color:sandybrown;'>muteMap</a><a style='color:red;'>,</a><div>
</div><a>                </a><a style='color:#2a6edb;'>deafMap:</a><a> </a><a style='color:sandybrown;'>deafMap</a><a style='color:red;'>,</a><div>
</div><a>                </a><a style='color:#2a6edb;'>activeSpeakerMap:</a><a> </a><a style='color:sandybrown;'>activeSpeakerMap</a><a style='color:red;'>,</a><div>
</div><a>                </a><a style='color:#2a6edb;'>roomId:</a><a> </a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><div>
</div><a>                </a><a style='color:#2a6edb;'>autoSpeaker:</a><a> </a><a style='color:sandybrown;'>autoSpeaker</a><a style='color:red;'>,</a><div>
</div><a>                </a><a style='color:#2a6edb;'>chatMode:</a><a> </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>Chat</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:chat_mode</a><a style='color:red;'>)</a><div>
</div><a>              </a><a style='color:red;'>}</a><div>
</div><div>
</div><a>              </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>d:</a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>op:</a><a> </a><a style='color:greenyellow;'>"fetch_done"</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>fetchId:</a><a> </a><a style='color:sandybrown;'>fetch_id</a><a style='color:red;'>}</a><div>
</div><a>          </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>        </a><a style='color:grey;'>_</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>          </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>op:</a><a> </a><a style='color:greenyellow;'>"error"</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>d:</a><a> </a><a style='color:greenyellow;'>"unexpected error"</a><a style='color:red;'>}</a><div>
</div><a>      </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>prepare_socket_msg</a><a style='color:red;'>(</a><a style='color:sandybrown;'>reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><a style='color:violet;'>end</a></code></html>