<html><head><link rel='stylesheet' href='styles.css'></head><code><a style='color:violet;'>defmodule</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Access</a><a style='color:red;'>.</a><a style='color:gold;'>Rooms</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>  </a><a style='color:violet;'>import</a><a> </a><a style='color:gold;'>Ecto</a><a style='color:red;'>.</a><a style='color:gold;'>Query</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>fetch_limit</a><a> </a><a style='color:#2a6edb;'>16</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Queries</a><a style='color:red;'>.</a><a style='color:gold;'>Rooms</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>as:</a><a> </a><a style='color:gold;'>Query</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Users</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>UserBlocks</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Repo</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>User</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>Room</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>UserBlock</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>RoomBlock</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>RoomPermissions</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>RoomBlocks</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>get_room_status</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>room</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Users</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get_current_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>cond</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:sandybrown;'>is_nil</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>      </a><a style='color:sandybrown;'>room</a><a style='color:red;'>.</a><a style='color:sandybrown;'>creatorId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:sandybrown;'>user_id</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:creator</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>room</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>      </a><a style='color:#2a6edb;'>true</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:sandybrown;'>case</a><a> </a><a style='color:gold;'>RoomPermissions</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>room</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>           </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>isMod:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><a> </a><a style='color:aquamarine;'>:mod</a><div>
</div><a>           </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>isSpeaker:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><a> </a><a style='color:aquamarine;'>:speaker</a><div>
</div><a>           </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>askedToSpeak:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><a> </a><a style='color:aquamarine;'>:askedToSpeak</a><div>
</div><a>           </a><a style='color:grey;'>_</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><a> </a><a style='color:aquamarine;'>:listener</a><div>
</div><a>         </a><a style='color:violet;'>end</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>room</a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>can_join_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>room</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>get_room_by_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:sandybrown;'>max_room_size</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Application</a><a style='color:red;'>.</a><a style='color:sandybrown;'>fetch_env!</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:kousa</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:max_room_size</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:sandybrown;'>room</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:#2a6edb;'>nil</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"room doesn't exist anymore"</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>      </a><a style='color:grey;'>_</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:sandybrown;'>cond</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>          </a><a style='color:sandybrown;'>room</a><a style='color:red;'>.</a><a style='color:sandybrown;'>numPeopleInside</a><a> </a><a style='color:red;'>>=</a><a> </a><a style='color:sandybrown;'>max_room_size</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>            </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"room is full"</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>          </a><a style='color:gold;'>RoomBlocks</a><a style='color:red;'>.</a><a style='color:sandybrown;'>blocked?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>            </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"you are blocked from the room"</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>          </a><a style='color:#2a6edb;'>true</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>            </a><a style='color:sandybrown;'>if</a><a> </a><a style='color:gold;'>UserBlocks</a><a style='color:red;'>.</a><a style='color:sandybrown;'>blocked?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room</a><a style='color:red;'>.</a><a style='color:sandybrown;'>creatorId</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>              </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"the creator of the room blocked you"</a><a style='color:red;'>}</a><div>
</div><a>            </a><a style='color:violet;'>else</a><div>
</div><a>              </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>room</a><a style='color:red;'>}</a><div>
</div><a>            </a><a style='color:violet;'>end</a><div>
</div><a>        </a><a style='color:violet;'>end</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>get_top_public_rooms</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>offset</a><a> </a><a style='color:red;'>\</a><a style='color:red;'>\</a><a> </a><a style='color:#2a6edb;'>0</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>max_room_size</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Application</a><a style='color:red;'>.</a><a style='color:sandybrown;'>fetch_env!</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:kousa</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:max_room_size</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>items</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>from</a><a style='color:red;'>(</a><a style='color:sandybrown;'>r</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:gold;'>Room</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>left_join:</a><a> </a><a style='color:sandybrown;'>rb</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:gold;'>RoomBlock</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>on:</a><a> </a><a style='color:sandybrown;'>rb</a><a style='color:red;'>.</a><a style='color:sandybrown;'>roomId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>rb</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>left_join:</a><a> </a><a style='color:sandybrown;'>ub</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:gold;'>UserBlock</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>on:</a><div>
</div><a>          </a><a style='color:red;'>(</a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>creatorId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:sandybrown;'>ub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userIdBlocked</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>ub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>or</a><div>
</div><a>            </a><a style='color:red;'>(</a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>creatorId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:sandybrown;'>ub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userId</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>ub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userIdBlocked</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>where:</a><div>
</div><a>          </a><a style='color:sandybrown;'>is_nil</a><a style='color:red;'>(</a><a style='color:sandybrown;'>ub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userIdBlocked</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>is_nil</a><a style='color:red;'>(</a><a style='color:sandybrown;'>rb</a><a style='color:red;'>.</a><a style='color:sandybrown;'>roomId</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>isPrivate</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:#2a6edb;'>false</a><a> </a><a style='color:violet;'>and</a><div>
</div><a>            </a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>numPeopleInside</a><a> </a><a style='color:red;'><</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>max_room_size</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>order_by:</a><a> </a><a style='color:red;'>[</a><a style='color:#2a6edb;'>desc:</a><a> </a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>numPeopleInside</a><a style='color:red;'>]</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>offset:</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>offset</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>limit:</a><a> </a><a style='color:red;'>^</a><a style='color:red;'>@</a><a style='color:sandybrown;'>fetch_limit</a><div>
</div><a>      </a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>all</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:gold;'>Enum</a><a style='color:red;'>.</a><a style='color:sandybrown;'>slice</a><a style='color:red;'>(</a><a style='color:sandybrown;'>items</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>0</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>-</a><a style='color:#2a6edb;'>1</a><a> </a><a style='color:red;'>+</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>fetch_limit</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>     </a><a style='color:sandybrown;'>if</a><a style='color:red;'>(</a><a style='color:sandybrown;'>length</a><a style='color:red;'>(</a><a style='color:sandybrown;'>items</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>fetch_limit</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:red;'>-</a><a style='color:#2a6edb;'>1</a><a> </a><a style='color:red;'>+</a><a> </a><a style='color:sandybrown;'>offset</a><a> </a><a style='color:red;'>+</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>fetch_limit</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>else:</a><a> </a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>spec</a><a> </a><a style='color:sandybrown;'>get_room_by_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>any</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>::</a><a> </a><a style='color:sandybrown;'>any</a><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>get_room_by_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:gold;'>Room</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>user_order</a><a> </a><a style='color:greenyellow;'>"""
    (case
      when ? then 1
      else 2
    end)
  """</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>spec</a><a> </a><a style='color:sandybrown;'>get_next_creator_for_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>any</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>::</a><a> </a><a style='color:sandybrown;'>any</a><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>get_next_creator_for_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>from</a><a style='color:red;'>(</a><a style='color:sandybrown;'>u</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:gold;'>User</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>inner_join:</a><a> </a><a style='color:sandybrown;'>rp</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>RoomPermission</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>on:</a><a> </a><a style='color:sandybrown;'>rp</a><a style='color:red;'>.</a><a style='color:sandybrown;'>roomId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>room_id</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>rp</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:sandybrown;'>u</a><a style='color:red;'>.</a><a style='color:sandybrown;'>id</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>u</a><a style='color:red;'>.</a><a style='color:sandybrown;'>currentRoomId</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>where:</a><a> </a><a style='color:sandybrown;'>rp</a><a style='color:red;'>.</a><a style='color:sandybrown;'>isSpeaker</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>limit:</a><a> </a><a style='color:#2a6edb;'>1</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>order_by:</a><a> </a><a style='color:red;'>[</a><div>
</div><a>        </a><a style='color:#2a6edb;'>asc:</a><a> </a><a style='color:sandybrown;'>fragment</a><a style='color:red;'>(</a><a style='color:red;'>@</a><a style='color:sandybrown;'>user_order</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>rp</a><a style='color:red;'>.</a><a style='color:sandybrown;'>isMod</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>]</a><div>
</div><a>    </a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>one</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>get_a_user_for_room</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>userStart</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>filter_by_current_room_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>limit_one</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>one</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>get_room_by_creator_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>creator_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>start</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>filter_by_creator_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>creator_id</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>limit_one</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>one</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>owner?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:violet;'>not</a><a> </a><a style='color:sandybrown;'>is_nil</a><a style='color:red;'>(</a><div>
</div><a>      </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>start</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>filter_by_room_id_and_creator_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>one</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>search_name</a><a style='color:red;'>(</a><a style='color:sandybrown;'>start_of_name</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>search_str</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>start_of_name</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:greenyellow;'>"%"</a><div>
</div><div>
</div><a>    </a><a style='color:gold;'>Query</a><a style='color:red;'>.</a><a style='color:sandybrown;'>start</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:sandybrown;'>where</a><a style='color:red;'>(</a><a style='color:red;'>[</a><a style='color:sandybrown;'>r</a><a style='color:red;'>]</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>ilike</a><a style='color:red;'>(</a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>name</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>search_str</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>and</a><a> </a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>isPrivate</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:#2a6edb;'>false</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:sandybrown;'>order_by</a><a style='color:red;'>(</a><a style='color:red;'>[</a><a style='color:sandybrown;'>r</a><a style='color:red;'>]</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>desc:</a><a> </a><a style='color:sandybrown;'>r</a><a style='color:red;'>.</a><a style='color:sandybrown;'>numPeopleInside</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:sandybrown;'>limit</a><a style='color:red;'>(</a><a style='color:red;'>[</a><a style='color:red;'>]</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>15</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>all</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>spec</a><a> </a><a style='color:sandybrown;'>all_rooms</a><a> </a><a style='color:red;'>::</a><a> </a><a style='color:sandybrown;'>any</a><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>all_rooms</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>all</a><a style='color:red;'>(</a><a style='color:gold;'>Room</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><a style='color:violet;'>end</a></code></html>