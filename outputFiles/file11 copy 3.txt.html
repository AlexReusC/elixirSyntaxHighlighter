<html><head><link rel='stylesheet' href='styles.css'></head><code><a style='color:violet;'>defmodule</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Routes</a><a style='color:red;'>.</a><a style='color:gold;'>Stats</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>  </a><a style='color:violet;'>import</a><a> </a><a style='color:gold;'>Plug</a><a style='color:red;'>.</a><a style='color:gold;'>Conn</a><div>
</div><a>  </a><a style='color:violet;'>import</a><a> </a><a style='color:gold;'>Ecto</a><a style='color:red;'>.</a><a style='color:gold;'>Query</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>use</a><a> </a><a style='color:gold;'>Plug</a><a style='color:red;'>.</a><a style='color:gold;'>Router</a><div>
</div><a>  </a><a style='color:sandybrown;'>use</a><a> </a><a style='color:gold;'>Timex</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>plug</a><a style='color:red;'>(</a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Plugs</a><a style='color:red;'>.</a><a style='color:gold;'>Cors</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:sandybrown;'>plug</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:match</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:sandybrown;'>plug</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:dispatch</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>StatsCache</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Repo</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>User</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>getStats</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>two_days_ago</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Timex</a><a style='color:red;'>.</a><a style='color:sandybrown;'>now</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Timex</a><a style='color:red;'>.</a><a style='color:sandybrown;'>shift</a><a style='color:red;'>(</a><a style='color:#2a6edb;'>days:</a><a> </a><a style='color:red;'>-</a><a style='color:#2a6edb;'>2</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>query</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>from</a><a style='color:red;'>(</a><a style='color:sandybrown;'>u</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:gold;'>User</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:#2a6edb;'>where:</a><a> </a><a style='color:sandybrown;'>u</a><a style='color:red;'>.</a><a style='color:sandybrown;'>lastOnline</a><a> </a><a style='color:red;'>></a><a> </a><a style='color:red;'>^</a><a style='color:sandybrown;'>two_days_ago</a><a> </a><a style='color:violet;'>or</a><a> </a><a style='color:sandybrown;'>u</a><a style='color:red;'>.</a><a style='color:sandybrown;'>online</a><div>
</div><a>      </a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>numActive</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>aggregate</a><a style='color:red;'>(</a><a style='color:sandybrown;'>query</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:count</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:id</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>d</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:red;'>{</a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>now!</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"Etc/UTC"</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:gold;'>Repo</a><a style='color:red;'>.</a><a style='color:sandybrown;'>aggregate</a><a style='color:red;'>(</a><a style='color:gold;'>User</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:count</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>numActive</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:gold;'>StatsCache</a><a style='color:red;'>.</a><a style='color:sandybrown;'>set</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"main"</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>d</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:sandybrown;'>d</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>get</a><a> </a><a style='color:greenyellow;'>"/"</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:sandybrown;'>dt</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:sandybrown;'>numUsers</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>numActive</a><a style='color:red;'>}</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:gold;'>StatsCache</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"main"</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>        </a><a style='color:#2a6edb;'>nil</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>          </a><a style='color:sandybrown;'>getStats</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:sandybrown;'>dt</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>stats</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>          </a><a style='color:grey;'># 1 day</a><div>
</div><a>          </a><a style='color:sandybrown;'>exp_dt</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>add</a><a style='color:red;'>(</a><a style='color:sandybrown;'>dt</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>60</a><a> </a><a style='color:red;'>*</a><a> </a><a style='color:#2a6edb;'>60</a><a> </a><a style='color:red;'>*</a><a> </a><a style='color:#2a6edb;'>24</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:second</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>          </a><a style='color:sandybrown;'>if</a><a> </a><a style='color:aquamarine;'>:lt</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>compare</a><a style='color:red;'>(</a><a style='color:sandybrown;'>exp_dt</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>now!</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"Etc/UTC"</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>            </a><a style='color:sandybrown;'>getStats</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>          </a><a style='color:violet;'>else</a><div>
</div><a>            </a><a style='color:red;'>{</a><a style='color:sandybrown;'>dt</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>stats</a><a style='color:red;'>}</a><div>
</div><a>          </a><a style='color:violet;'>end</a><div>
</div><a>      </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>conn</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:sandybrown;'>put_resp_content_type</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"application/json"</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:sandybrown;'>send_resp</a><a style='color:red;'>(</a><div>
</div><a>      </a><a style='color:#2a6edb;'>200</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:gold;'>Jason</a><a style='color:red;'>.</a><a style='color:sandybrown;'>encode!</a><a style='color:red;'>(</a><a style='color:red;'>%{</a><div>
</div><a>        </a><a style='color:greenyellow;'>"numUsers"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>numUsers</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:greenyellow;'>"activeInLastTwoDays"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>numActive</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:greenyellow;'>"lastUpdated"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>to_iso8601</a><a style='color:red;'>(</a><a style='color:sandybrown;'>dt</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><a style='color:violet;'>end</a></code></html>