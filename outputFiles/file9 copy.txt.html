<html><head><link rel='stylesheet' href='styles.css'></head><code><a style='color:violet;'>defmodule</a><a> </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>VoiceRabbit</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>  </a><a style='color:sandybrown;'>use</a><a> </a><a style='color:gold;'>GenServer</a><div>
</div><a>  </a><a style='color:sandybrown;'>use</a><a> </a><a style='color:gold;'>AMQP</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>defmodule</a><a> </a><a style='color:gold;'>State</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>@</a><a style='color:sandybrown;'>type</a><a> </a><a style='color:sandybrown;'>t</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:red;'>%{</a><div>
</div><a>            </a><a style='color:#2a6edb;'>id:</a><a> </a><a style='color:gold;'>String</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>chan:</a><a> </a><a style='color:sandybrown;'>map</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>          </a><a style='color:red;'>}</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>defstruct</a><a> </a><a style='color:#2a6edb;'>id:</a><a> </a><a style='color:greenyellow;'>""</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>chan:</a><a> </a><a style='color:#2a6edb;'>nil</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>start_supervised</a><a style='color:red;'>(</a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>DynamicSupervisor</a><a style='color:red;'>.</a><a style='color:sandybrown;'>start_child</a><a style='color:red;'>(</a><div>
</div><a>      </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>VoiceRabbitDynamicSupervisor</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:red;'>{</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>start_link</a><a style='color:red;'>(</a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>GenServer</a><a style='color:red;'>.</a><a style='color:sandybrown;'>start_link</a><a style='color:red;'>(</a><div>
</div><a>      </a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>name:</a><a> </a><a style='color:sandybrown;'>via</a><a style='color:red;'>(</a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>via</a><a style='color:red;'>(</a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:via</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Registry</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>VoiceRabbitRegistry</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'># @send_exchange "shawarma_exchange"</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>send_queue</a><a> </a><a style='color:greenyellow;'>"shawarma_queue"</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>receive_exchange</a><a> </a><a style='color:greenyellow;'>"kousa_exchange"</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>receive_queue</a><a> </a><a style='color:greenyellow;'>"kousa_queue"</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>init</a><a style='color:red;'>(</a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>conn</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:gold;'>Connection</a><a style='color:red;'>.</a><a style='color:sandybrown;'>open</a><a style='color:red;'>(</a><a style='color:gold;'>Application</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get_env</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:kousa</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:rabbit_url</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"amqp://guest:guest@localhost"</a><a style='color:red;'>)</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>chan</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Channel</a><a style='color:red;'>.</a><a style='color:sandybrown;'>open</a><a style='color:red;'>(</a><a style='color:sandybrown;'>conn</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:sandybrown;'>setup_queue</a><a style='color:red;'>(</a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>chan</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>queue_to_consume</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>receive_queue</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>voice_id</a><div>
</div><a>    </a><a style='color:gold;'>IO</a><a style='color:red;'>.</a><a style='color:sandybrown;'>puts</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"queue_to_consume: "</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>queue_to_consume</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:grey;'># Register the GenServer process as a consumer</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_consumer_tag</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Basic</a><a style='color:red;'>.</a><a style='color:sandybrown;'>consume</a><a style='color:red;'>(</a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>queue_to_consume</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>no_ack:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:gold;'>State</a><a style='color:red;'>{</a><a style='color:#2a6edb;'>chan:</a><a> </a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>id:</a><a> </a><a style='color:sandybrown;'>voice_id</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>send</a><a style='color:red;'>(</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>msg</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>GenServer</a><a style='color:red;'>.</a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>via</a><a style='color:red;'>(</a><a style='color:sandybrown;'>id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:send</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>msg</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:send</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>msg</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:gold;'>State</a><a style='color:red;'>{</a><a style='color:#2a6edb;'>chan:</a><a> </a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>id:</a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>AMQP</a><a style='color:red;'>.</a><a style='color:gold;'>Basic</a><a style='color:red;'>.</a><a style='color:sandybrown;'>publish</a><a style='color:red;'>(</a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>""</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>send_queue</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Jason</a><a style='color:red;'>.</a><a style='color:sandybrown;'>encode!</a><a style='color:red;'>(</a><a style='color:sandybrown;'>msg</a><a style='color:red;'>)</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_info</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:basic_consume_ok</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>consumer_tag:</a><a> </a><a style='color:grey;'>_consumer_tag</a><a style='color:red;'>}</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'># Sent by the broker when the consumer is unexpectedly cancelled (such as after a queue deletion)</a><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_info</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:basic_cancel</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>consumer_tag:</a><a> </a><a style='color:grey;'>_consumer_tag</a><a style='color:red;'>}</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:stop</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:normal</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'># Confirmation sent by the broker to the consumer process after a Basic.cancel</a><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_info</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:basic_cancel_ok</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>consumer_tag:</a><a> </a><a style='color:grey;'>_consumer_tag</a><a style='color:red;'>}</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_info</a><a style='color:red;'>(</a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:basic_deliver</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>delivery_tag:</a><a> </a><a style='color:grey;'>_tag</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>redelivered:</a><a> </a><a style='color:grey;'>_redelivered</a><a style='color:red;'>}</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>        </a><a style='color:red;'>%</a><a style='color:gold;'>State</a><a style='color:red;'>{</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><div>
</div><a>      </a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>data</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Jason</a><a style='color:red;'>.</a><a style='color:sandybrown;'>decode!</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:sandybrown;'>data</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"uid"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>UserSession</a><a style='color:red;'>.</a><a style='color:sandybrown;'>send_ws</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>delete</a><a style='color:red;'>(</a><a style='color:sandybrown;'>data</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"uid"</a><a style='color:red;'>)</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>      </a><a style='color:red;'>%{</a><a style='color:greenyellow;'>"rid"</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>RoomSession</a><a style='color:red;'>.</a><a style='color:sandybrown;'>broadcast_ws</a><a style='color:red;'>(</a><div>
</div><a>          </a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>delete</a><a style='color:red;'>(</a><a style='color:sandybrown;'>data</a><a style='color:red;'>,</a><a> </a><a style='color:greenyellow;'>"rid"</a><a style='color:red;'>)</a><div>
</div><a>        </a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>    </a><a style='color:grey;'># You might want to run payload consumption in separate Tasks in production</a><div>
</div><a>    </a><a style='color:grey;'># consume(chan, tag, redelivered, payload)</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>setup_queue</a><a style='color:red;'>(</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>chan</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Queue</a><a style='color:red;'>.</a><a style='color:sandybrown;'>declare</a><a style='color:red;'>(</a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>send_queue</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>durable:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Queue</a><a style='color:red;'>.</a><a style='color:sandybrown;'>declare</a><a style='color:red;'>(</a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>receive_queue</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>durable:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:aquamarine;'>:ok</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Exchange</a><a style='color:red;'>.</a><a style='color:sandybrown;'>fanout</a><a style='color:red;'>(</a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>receive_exchange</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>durable:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:aquamarine;'>:ok</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Queue</a><a style='color:red;'>.</a><a style='color:sandybrown;'>bind</a><a style='color:red;'>(</a><a style='color:sandybrown;'>chan</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>receive_queue</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>@</a><a style='color:sandybrown;'>receive_exchange</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><a style='color:violet;'>end</a></code></html>