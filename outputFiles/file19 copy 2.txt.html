<html><head><link rel='stylesheet' href='styles.css'></head><code><div>
</div><a style='color:violet;'>defmodule</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>.</a><a style='color:gold;'>Call</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>moduledoc</a><a> </a><a style='color:greenyellow;'>"""
  API contract statement for call message modules
  ## Usage:
  ```elixir
  using Broth.Message.Call, reply: <module>
  ```
  if you omit the reply module, it assumes the value
  `__MODULE__.Reply`
  performs compile-time checks to validate that the reply module
  is, indeed, a reply module.
  If this route can be used without authorization, set the
  `:needs_auth` keyword parameter to false.
  """</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>.</a><a style='color:gold;'>Cast</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defmacro</a><a> </a><a style='color:grey;'>__using__</a><a style='color:red;'>(</a><a style='color:sandybrown;'>opts</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>default_reply_module</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Module</a><a style='color:red;'>.</a><a style='color:sandybrown;'>concat</a><a style='color:red;'>(</a><a style='color:grey;'>__CALLER__</a><a style='color:red;'>.</a><a style='color:sandybrown;'>module</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Reply</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>reply_module</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>opts</a><div>
</div><a>      </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Keyword</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>default_reply_module</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Macro</a><a style='color:red;'>.</a><a style='color:sandybrown;'>expand</a><a style='color:red;'>(</a><a style='color:grey;'>__CALLER__</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>directions</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>if</a><a> </a><a style='color:sandybrown;'>reply_module</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:grey;'>__CALLER__</a><a style='color:red;'>.</a><a style='color:sandybrown;'>module</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>        </a><a style='color:red;'>[</a><a style='color:aquamarine;'>:inbound</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:outbound</a><a style='color:red;'>]</a><div>
</div><a>      </a><a style='color:violet;'>else</a><div>
</div><a>        </a><a style='color:red;'>[</a><a style='color:aquamarine;'>:inbound</a><a style='color:red;'>]</a><div>
</div><a>      </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>auth_check</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>opts</a><div>
</div><a>      </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Keyword</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:needs_auth</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Cast</a><a style='color:red;'>.</a><a style='color:sandybrown;'>auth_check</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>quote</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:sandybrown;'>use</a><a> </a><a style='color:gold;'>Ecto</a><a style='color:red;'>.</a><a style='color:gold;'>Schema</a><div>
</div><a>      </a><a style='color:violet;'>import</a><a> </a><a style='color:gold;'>Ecto</a><a style='color:red;'>.</a><a style='color:gold;'>Changeset</a><div>
</div><div>
</div><a>      </a><a style='color:red;'>@</a><a style='color:sandybrown;'>behaviour</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>.</a><a style='color:gold;'>Call</a><div>
</div><div>
</div><a>      </a><a style='color:gold;'>Module</a><a style='color:red;'>.</a><a style='color:sandybrown;'>register_attribute</a><a style='color:red;'>(</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:directions</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>accumulate:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>persist:</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:red;'>@</a><a style='color:sandybrown;'>directions</a><a> </a><a style='color:sandybrown;'>unquote</a><a style='color:red;'>(</a><a style='color:sandybrown;'>directions</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>      </a><a style='color:sandybrown;'>unquote</a><a style='color:red;'>(</a><a style='color:sandybrown;'>auth_check</a><a style='color:red;'>)</a><div>
</div><a>      </a><a style='color:sandybrown;'>unquote</a><a style='color:red;'>(</a><a style='color:gold;'>Cast</a><a style='color:red;'>.</a><a style='color:sandybrown;'>schema_ast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>opts</a><a style='color:red;'>)</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>      </a><a style='color:red;'>@</a><a style='color:sandybrown;'>impl</a><a> </a><a style='color:#2a6edb;'>true</a><div>
</div><a>      </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>reply_module</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>unquote</a><a style='color:red;'>(</a><a style='color:sandybrown;'>reply_module</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>      </a><a style='color:red;'>@</a><a style='color:sandybrown;'>impl</a><a> </a><a style='color:#2a6edb;'>true</a><div>
</div><a>      </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>initialize</a><a style='color:red;'>(</a><a style='color:grey;'>_state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>struct</a><a style='color:red;'>(</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>      </a><a style='color:sandybrown;'>defoverridable</a><a> </a><a style='color:#2a6edb;'>initialize:</a><a> </a><a style='color:#2a6edb;'>1</a><div>
</div><div>
</div><a>      </a><a style='color:grey;'># verify compile-time guarantees</a><div>
</div><a>      </a><a style='color:red;'>@</a><a style='color:sandybrown;'>after_compile</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>.</a><a style='color:gold;'>Call</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Ecto</a><a style='color:red;'>.</a><a style='color:gold;'>Changeset</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>SocketHandler</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>callback</a><a> </a><a style='color:sandybrown;'>auth_check</a><a style='color:red;'>(</a><a style='color:gold;'>SocketHandler</a><a style='color:red;'>.</a><a style='color:sandybrown;'>state</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:aquamarine;'>:ok</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:auth</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>callback</a><a> </a><a style='color:sandybrown;'>reply_module</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:sandybrown;'>module</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>callback</a><a> </a><a style='color:sandybrown;'>execute</a><a style='color:red;'>(</a><a style='color:gold;'>Changeset</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>SocketHandler</a><a style='color:red;'>.</a><a style='color:sandybrown;'>state</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><div>
</div><a>              </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>map</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>SocketHandler</a><a style='color:red;'>.</a><a style='color:sandybrown;'>state</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>              </a><a style='color:red;'>|</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>SocketHandler</a><a style='color:red;'>.</a><a style='color:sandybrown;'>state</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>              </a><a style='color:red;'>|</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>map</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>SocketHandler</a><a style='color:red;'>.</a><a style='color:sandybrown;'>state</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>              </a><a style='color:red;'>|</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Changeset</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>              </a><a style='color:red;'>|</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:close</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>code</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:#2a6edb;'>1000</a><a style='color:red;'>..</a><a style='color:#2a6edb;'>9999</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>reason</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:gold;'>String</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>callback</a><a> </a><a style='color:sandybrown;'>initialize</a><a style='color:red;'>(</a><a style='color:gold;'>SocketHandler</a><a style='color:red;'>.</a><a style='color:sandybrown;'>state</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:sandybrown;'>struct</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>callback</a><a> </a><a style='color:sandybrown;'>changeset</a><a style='color:red;'>(</a><a style='color:sandybrown;'>struct</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:sandybrown;'>json</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:gold;'>Ecto</a><a style='color:red;'>.</a><a style='color:gold;'>Changeset</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:grey;'>__after_compile__</a><a style='color:red;'>(</a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>module:</a><a> </a><a style='color:sandybrown;'>module</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_bin</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:grey;'># checks to make sure you've either declared a schema module, or you have</a><div>
</div><a>    </a><a style='color:grey;'># implemented a schema</a><div>
</div><a>    </a><a style='color:gold;'>Cast</a><a style='color:red;'>.</a><a style='color:sandybrown;'>check_for_schema</a><a style='color:red;'>(</a><a style='color:sandybrown;'>module</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:inbound</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:grey;'># checks to make sure the declared reply module actually exists.</a><div>
</div><a>    </a><a style='color:sandybrown;'>reply_module</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>module</a><a style='color:red;'>.</a><a style='color:sandybrown;'>reply_module</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:gold;'>Code</a><a style='color:red;'>.</a><a style='color:sandybrown;'>ensure_compiled</a><a style='color:red;'>(</a><a style='color:sandybrown;'>reply_module</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:gold;'>Cast</a><a style='color:red;'>.</a><a style='color:sandybrown;'>check_for_schema</a><a style='color:red;'>(</a><a style='color:sandybrown;'>reply_module</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:outbound</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><a style='color:violet;'>end</a></code></html>