<html><head><link rel='stylesheet' href='styles.css'></head><code><a style='color:violet;'>defmodule</a><a> </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>Chat</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>  </a><a style='color:sandybrown;'>use</a><a> </a><a style='color:gold;'>GenServer</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>restart:</a><a> </a><a style='color:aquamarine;'>:temporary</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>PubSub</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>.</a><a style='color:gold;'>Chat</a><a style='color:red;'>.</a><a style='color:gold;'>Delete</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>.</a><a style='color:gold;'>Chat</a><a style='color:red;'>.</a><a style='color:gold;'>Send</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Kousa</a><a style='color:red;'>.</a><a style='color:gold;'>Utils</a><a style='color:red;'>.</a><a style='color:gold;'>UUID</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>require</a><a> </a><a style='color:gold;'>Logger</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defstruct</a><a> </a><a style='color:#2a6edb;'>room_id:</a><a> </a><a style='color:greenyellow;'>""</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>room_creator_id:</a><a> </a><a style='color:greenyellow;'>""</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>users:</a><a> </a><a style='color:red;'>[</a><a style='color:red;'>]</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>ban_map:</a><a> </a><a style='color:red;'>%{</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>last_message_map:</a><a> </a><a style='color:red;'>%{</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>follow_at_map:</a><a> </a><a style='color:red;'>%{</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>chat_mode:</a><a> </a><a style='color:aquamarine;'>:default</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>chat_throttle:</a><a> </a><a style='color:#2a6edb;'>1000</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>type</a><a> </a><a style='color:sandybrown;'>state</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><div>
</div><a>          </a><a style='color:#2a6edb;'>room_id:</a><a> </a><a style='color:gold;'>String</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>room_creator_id:</a><a> </a><a style='color:gold;'>String</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>users:</a><a> </a><a style='color:red;'>[</a><a style='color:gold;'>String</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>]</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>ban_map:</a><a> </a><a style='color:sandybrown;'>map</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>last_message_map:</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>optional</a><a style='color:red;'>(</a><a style='color:gold;'>UUID</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>follow_at_map:</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>optional</a><a style='color:red;'>(</a><a style='color:gold;'>UUID</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>=></a><a> </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>chat_mode:</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>Room</a><a style='color:red;'>.</a><a style='color:sandybrown;'>chatMode</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>chat_throttle:</a><a> </a><a style='color:sandybrown;'>integer</a><a style='color:red;'>(</a><a style='color:red;'>)</a><div>
</div><a>        </a><a style='color:red;'>}</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'>#################################################################################</a><div>
</div><a>  </a><a style='color:grey;'># REGISTRY AND SUPERVISION BOILERPLATE</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>via</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:via</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Registry</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>RoomChatRegistry</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>params</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:gold;'>GenServer</a><a style='color:red;'>.</a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>via</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>params</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>call</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>params</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:gold;'>GenServer</a><a style='color:red;'>.</a><a style='color:sandybrown;'>call</a><a style='color:red;'>(</a><a style='color:sandybrown;'>via</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>params</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>start_link_supervised</a><a style='color:red;'>(</a><a style='color:sandybrown;'>initial_values</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>callers</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:red;'>[</a><a style='color:sandybrown;'>self</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:gold;'>Process</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:"$callers"</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>[</a><a style='color:red;'>]</a><a style='color:red;'>)</a><a style='color:red;'>]</a><div>
</div><div>
</div><a>    </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:gold;'>DynamicSupervisor</a><a style='color:red;'>.</a><a style='color:sandybrown;'>start_child</a><a style='color:red;'>(</a><div>
</div><a>           </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>RoomChatDynamicSupervisor</a><a style='color:red;'>,</a><div>
</div><a>           </a><a style='color:red;'>{</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Keyword</a><a style='color:red;'>.</a><a style='color:sandybrown;'>merge</a><a style='color:red;'>(</a><a style='color:sandybrown;'>initial_values</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>callers:</a><a> </a><a style='color:sandybrown;'>callers</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>         </a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>pid</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:grey;'># ensures that the chat dies alongside the room</a><div>
</div><a>        </a><a style='color:gold;'>Process</a><a style='color:red;'>.</a><a style='color:sandybrown;'>link</a><a style='color:red;'>(</a><a style='color:sandybrown;'>pid</a><a style='color:red;'>)</a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>pid</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>      </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:error</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:already_started</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>pid</a><a style='color:red;'>}</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:gold;'>Logger</a><a style='color:red;'>.</a><a style='color:sandybrown;'>warn</a><a style='color:red;'>(</a><div>
</div><a>          </a><a style='color:greenyellow;'>"unexpectedly tried to restart already started Room chat #{initial_values[:room_id]}"</a><div>
</div><a>        </a><a style='color:red;'>)</a><div>
</div><div>
</div><a>        </a><a style='color:gold;'>Process</a><a style='color:red;'>.</a><a style='color:sandybrown;'>link</a><a style='color:red;'>(</a><a style='color:sandybrown;'>pid</a><a style='color:red;'>)</a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ignored</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>pid</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>      </a><a style='color:sandybrown;'>error</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:sandybrown;'>error</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>child_spec</a><a style='color:red;'>(</a><a style='color:sandybrown;'>init</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>super</a><a style='color:red;'>(</a><a style='color:sandybrown;'>init</a><a style='color:red;'>)</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>id:</a><a> </a><a style='color:gold;'>Keyword</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:sandybrown;'>init</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:room_id</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>count</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:gold;'>Registry</a><a style='color:red;'>.</a><a style='color:sandybrown;'>count</a><a style='color:red;'>(</a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>RoomChatRegistry</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'>###############################################################################</a><div>
</div><a>  </a><a style='color:grey;'>## INITIALIZATION BOILERPLATE</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>start_link</a><a style='color:red;'>(</a><a style='color:sandybrown;'>init</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>GenServer</a><a style='color:red;'>.</a><a style='color:sandybrown;'>start_link</a><a style='color:red;'>(</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>init</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>name:</a><a> </a><a style='color:sandybrown;'>via</a><a style='color:red;'>(</a><a style='color:sandybrown;'>init</a><a style='color:red;'>[</a><a style='color:aquamarine;'>:room_id</a><a style='color:red;'>]</a><a style='color:red;'>)</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>init</a><a style='color:red;'>(</a><a style='color:sandybrown;'>init</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:grey;'># adopt callers from the call point.</a><div>
</div><a>    </a><a style='color:gold;'>Process</a><a style='color:red;'>.</a><a style='color:sandybrown;'>put</a><a style='color:red;'>(</a><a style='color:aquamarine;'>:"$callers"</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>init</a><a style='color:red;'>[</a><a style='color:aquamarine;'>:callers</a><a style='color:red;'>]</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ok</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>struct</a><a style='color:red;'>(</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>init</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>kill</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>RoomChatRegistry</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Registry</a><a style='color:red;'>.</a><a style='color:sandybrown;'>lookup</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Enum</a><a style='color:red;'>.</a><a style='color:sandybrown;'>each</a><a style='color:red;'>(</a><a style='color:violet;'>fn</a><a> </a><a style='color:red;'>{</a><a style='color:sandybrown;'>room_pid</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>      </a><a style='color:gold;'>Process</a><a style='color:red;'>.</a><a style='color:sandybrown;'>exit</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_pid</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:kill</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:violet;'>end</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>ws_fan</a><a style='color:red;'>(</a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>msg</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>Enum</a><a style='color:red;'>.</a><a style='color:sandybrown;'>each</a><a style='color:red;'>(</a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><a> </a><a style='color:violet;'>fn</a><a> </a><a style='color:sandybrown;'>uid</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>      </a><a style='color:gold;'>Onion</a><a style='color:red;'>.</a><a style='color:gold;'>UserSession</a><a style='color:red;'>.</a><a style='color:sandybrown;'>send_ws</a><a style='color:red;'>(</a><a style='color:sandybrown;'>uid</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>nil</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>msg</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:violet;'>end</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'>######################################################################</a><div>
</div><a>  </a><a style='color:grey;'>## API</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>set_room_creator_id</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set_room_creator_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>set_room_creator_id_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>room_creator_id:</a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>follow_at_map:</a><a> </a><a style='color:red;'>%{</a><a style='color:red;'>}</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>set_chat_throttle</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set_chat_throttle</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>set_chat_throttle_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>value</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>chat_throttle:</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>banned?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>who</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>call</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:banned?</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>who</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>banned_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>who</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_banned?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>who</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>user_banned?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>who</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>who</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>keys</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>ban_map</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Follows</a><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Schemas</a><a style='color:red;'>.</a><a style='color:gold;'>Follow</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'># users that meet the following criteria,</a><div>
</div><a>  </a><a style='color:grey;'># can chat in follower_only mode:</a><div>
</div><a>  </a><a style='color:grey;'># 0. creator of room</a><div>
</div><a>  </a><a style='color:grey;'># 1. mod</a><div>
</div><a>  </a><a style='color:grey;'># 2. speaker</a><div>
</div><a>  </a><a style='color:grey;'># 3. following room owner prior to joining room</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>eligible_to_chat?</a><a style='color:red;'>(</a><div>
</div><a>         </a><a style='color:sandybrown;'>from</a><a style='color:red;'>,</a><div>
</div><a>         </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><div>
</div><a>           </a><a style='color:#2a6edb;'>chat_mode:</a><a> </a><a style='color:aquamarine;'>:follower_only</a><a style='color:red;'>,</a><div>
</div><a>           </a><a style='color:#2a6edb;'>room_creator_id:</a><a> </a><a style='color:sandybrown;'>room_creator_id</a><div>
</div><a>         </a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><div>
</div><a>       </a><a style='color:red;'>)</a><div>
</div><a>       </a><a style='color:violet;'>when</a><a> </a><a style='color:sandybrown;'>from</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:sandybrown;'>room_creator_id</a><a style='color:red;'>,</a><div>
</div><a>       </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:red;'>{</a><a style='color:sandybrown;'>state</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>alias</a><a> </a><a style='color:gold;'>Beef</a><a style='color:red;'>.</a><a style='color:gold;'>Rooms</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>eligible_to_chat?</a><a style='color:red;'>(</a><div>
</div><a>         </a><a style='color:sandybrown;'>from</a><a style='color:red;'>,</a><div>
</div><a>         </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><div>
</div><a>           </a><a style='color:#2a6edb;'>chat_mode:</a><a> </a><a style='color:aquamarine;'>:follower_only</a><a style='color:red;'>,</a><div>
</div><a>           </a><a style='color:#2a6edb;'>room_creator_id:</a><a> </a><a style='color:sandybrown;'>room_creator_id</a><a style='color:red;'>,</a><div>
</div><a>           </a><a style='color:#2a6edb;'>follow_at_map:</a><a> </a><a style='color:sandybrown;'>follow_at_map</a><div>
</div><a>         </a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><div>
</div><a>       </a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:sandybrown;'>new_state</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>inserted_at_or_true</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><div>
</div><a>      </a><a style='color:sandybrown;'>if</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>has_key?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>follow_at_map</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>from</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>        </a><a style='color:grey;'># cache hit</a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:sandybrown;'>state</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:sandybrown;'>follow_at_map</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>from</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>      </a><a style='color:violet;'>else</a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:sandybrown;'>status</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:gold;'>Rooms</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get_room_status</a><a style='color:red;'>(</a><a style='color:sandybrown;'>from</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>        </a><a style='color:grey;'># cache miss</a><div>
</div><a>        </a><a style='color:sandybrown;'>inserted_at_or_true</a><a> </a><a style='color:red;'>=</a><div>
</div><a>          </a><a style='color:sandybrown;'>if</a><a> </a><a style='color:sandybrown;'>status</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:red;'>[</a><a style='color:aquamarine;'>:mod</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:speaker</a><a style='color:red;'>]</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>            </a><a style='color:#2a6edb;'>true</a><div>
</div><a>          </a><a style='color:violet;'>else</a><div>
</div><a>            </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:gold;'>Follows</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get_follow</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_creator_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>from</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>              </a><a style='color:#2a6edb;'>nil</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>                </a><a style='color:#2a6edb;'>nil</a><div>
</div><div>
</div><a>              </a><a style='color:red;'>%</a><a style='color:gold;'>Follow</a><a style='color:red;'>{</a><a style='color:#2a6edb;'>inserted_at:</a><a> </a><a style='color:sandybrown;'>inserted_at</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>                </a><a style='color:sandybrown;'>inserted_at</a><div>
</div><a>            </a><a style='color:violet;'>end</a><div>
</div><a>          </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>follow_at_map:</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>put</a><a style='color:red;'>(</a><a style='color:sandybrown;'>follow_at_map</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>from</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>inserted_at_or_true</a><a style='color:red;'>)</a><a style='color:red;'>}</a><a style='color:red;'>,</a><div>
</div><a>         </a><a style='color:sandybrown;'>inserted_at_or_true</a><a style='color:red;'>}</a><div>
</div><a>      </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:sandybrown;'>new_state</a><a style='color:red;'>,</a><a> </a><a style='color:violet;'>not</a><a> </a><a style='color:sandybrown;'>is_nil</a><a style='color:red;'>(</a><a style='color:sandybrown;'>inserted_at_or_true</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>eligible_to_chat?</a><a style='color:red;'>(</a><a style='color:grey;'>_</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:red;'>{</a><a style='color:sandybrown;'>state</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>}</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>unban_user</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:unban_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>remove_user</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:remove_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>remove_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>users:</a><a> </a><a style='color:gold;'>Enum</a><a style='color:red;'>.</a><a style='color:sandybrown;'>reject</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>&</a><a style='color:red;'>(</a><a style='color:red;'>&</a><a style='color:#2a6edb;'>1</a><a> </a><a style='color:red;'>==</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>add_user</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:add_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>add_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>if</a><a> </a><a style='color:sandybrown;'>user_id</a><a> </a><a style='color:violet;'>in</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>users</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:violet;'>else</a><div>
</div><a>      </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>users:</a><a> </a><a style='color:red;'>[</a><a style='color:sandybrown;'>user_id</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>users</a><a style='color:red;'>]</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>ban_user</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ban_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>ban_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>ws_fan</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><div>
</div><a>      </a><a style='color:#2a6edb;'>op:</a><a> </a><a style='color:greenyellow;'>"chat_user_banned"</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>d:</a><a> </a><a style='color:red;'>%{</a><div>
</div><a>        </a><a style='color:#2a6edb;'>userId:</a><a> </a><a style='color:sandybrown;'>user_id</a><div>
</div><a>      </a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>ban_map:</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>put</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>ban_map</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>1</a><a style='color:red;'>)</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>unban_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>ws_fan</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>users</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><div>
</div><a>      </a><a style='color:#2a6edb;'>op:</a><a> </a><a style='color:greenyellow;'>"chat_user_unbanned"</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>d:</a><a> </a><a style='color:red;'>%{</a><div>
</div><a>        </a><a style='color:#2a6edb;'>userId:</a><a> </a><a style='color:sandybrown;'>user_id</a><div>
</div><a>      </a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>ban_map:</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>delete</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>ban_map</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>set_can_chat</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set_can_chat</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>set_can_chat_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><a style='color:#2a6edb;'>follow_at_map:</a><a> </a><a style='color:sandybrown;'>follow_at_map</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%{</a><a style='color:sandybrown;'>state</a><a> </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>follow_at_map:</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>put</a><a style='color:red;'>(</a><a style='color:sandybrown;'>follow_at_map</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>true</a><a style='color:red;'>)</a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>set</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>set_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>put</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>)</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>call</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:get</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>get_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:reply</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>get</a><a style='color:red;'>(</a><a style='color:sandybrown;'>state</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'>#####################################################################</a><div>
</div><a>  </a><a style='color:grey;'>## send message</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>spec</a><a> </a><a style='color:sandybrown;'>send_msg</a><a style='color:red;'>(</a><a style='color:gold;'>UUID</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Send</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:aquamarine;'>:ok</a><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>send_msg</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:send_msg</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>send_msg_impl</a><a style='color:red;'>(</a><a style='color:grey;'>_</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><a style='color:#2a6edb;'>chat_mode:</a><a> </a><a style='color:aquamarine;'>:disabled</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>spec</a><a> </a><a style='color:sandybrown;'>send_msg_impl</a><a style='color:red;'>(</a><a style='color:gold;'>Send</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>send_msg_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:red;'>%{</a><a style='color:#2a6edb;'>from:</a><a> </a><a style='color:sandybrown;'>from</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:grey;'># throttle sender</a><div>
</div><a>    </a><a style='color:sandybrown;'>with</a><a> </a><a style='color:#2a6edb;'>false</a><a> </a><a style='color:red;'><</a><a style='color:red;'>-</a><a> </a><a style='color:sandybrown;'>should_throttle?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>from</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><div>
</div><a>         </a><a style='color:#2a6edb;'>false</a><a> </a><a style='color:red;'><</a><a style='color:red;'>-</a><a> </a><a style='color:sandybrown;'>user_banned?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>from</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:red;'>{</a><a style='color:sandybrown;'>new_state</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>can_chat</a><a style='color:red;'>}</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:sandybrown;'>eligible_to_chat?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>from</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>      </a><a style='color:sandybrown;'>if</a><a> </a><a style='color:sandybrown;'>can_chat</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>        </a><a style='color:sandybrown;'>dispatch_message</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>new_state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><div>
</div><a>         </a><a style='color:red;'>%{</a><div>
</div><a>           </a><a style='color:sandybrown;'>new_state</a><div>
</div><a>           </a><a style='color:red;'>|</a><a> </a><a style='color:#2a6edb;'>last_message_map:</a><a> </a><a style='color:gold;'>Map</a><a style='color:red;'>.</a><a style='color:sandybrown;'>put</a><a style='color:red;'>(</a><a style='color:sandybrown;'>new_state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>last_message_map</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>from</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>utc_now</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><div>
</div><a>         </a><a style='color:red;'>}</a><a style='color:red;'>}</a><div>
</div><a>      </a><a style='color:violet;'>else</a><div>
</div><a>        </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>new_state</a><a style='color:red;'>}</a><div>
</div><a>      </a><a style='color:violet;'>end</a><div>
</div><a>    </a><a style='color:violet;'>else</a><div>
</div><a>      </a><a style='color:grey;'>_</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>spec</a><a> </a><a style='color:sandybrown;'>should_throttle?</a><a style='color:red;'>(</a><a style='color:gold;'>UUID</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:sandybrown;'>boolean</a><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>should_throttle?</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:grey;'>__MODULE__</a><a style='color:red;'>{</a><a style='color:#2a6edb;'>last_message_map:</a><a> </a><a style='color:sandybrown;'>m</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>chat_throttle:</a><a> </a><a style='color:sandybrown;'>ct</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>       </a><a style='color:violet;'>when</a><a> </a><a style='color:sandybrown;'>is_map_key</a><a style='color:red;'>(</a><a style='color:sandybrown;'>m</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>diff</a><a style='color:red;'>(</a><a style='color:gold;'>DateTime</a><a style='color:red;'>.</a><a style='color:sandybrown;'>utc_now</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>m</a><a style='color:red;'>[</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>]</a><a style='color:red;'>,</a><a> </a><a style='color:aquamarine;'>:millisecond</a><a style='color:red;'>)</a><a> </a><a style='color:red;'><</a><div>
</div><a>      </a><a style='color:sandybrown;'>ct</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>should_throttle?</a><a style='color:red;'>(</a><a style='color:grey;'>_</a><a style='color:red;'>,</a><a> </a><a style='color:grey;'>_</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:#2a6edb;'>false</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>dispatch_message</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>case</a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>.</a><a style='color:sandybrown;'>whisperedTo</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>      </a><a style='color:red;'>[</a><a style='color:red;'>]</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:gold;'>PubSub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>broadcast</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"chat:"</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>{</a><div>
</div><a>          </a><a style='color:#2a6edb;'>operator:</a><a> </a><a style='color:greenyellow;'>"chat:send"</a><a style='color:red;'>,</a><div>
</div><a>          </a><a style='color:#2a6edb;'>payload:</a><a> </a><a style='color:sandybrown;'>payload</a><div>
</div><a>        </a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>        </a><a style='color:aquamarine;'>:ok</a><div>
</div><div>
</div><a>      </a><a style='color:sandybrown;'>list</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>        </a><a style='color:grey;'># I am doing user blocking at socket_handler level</a><div>
</div><a>        </a><a style='color:sandybrown;'>list</a><div>
</div><a>        </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>List</a><a style='color:red;'>.</a><a style='color:sandybrown;'>insert_at</a><a style='color:red;'>(</a><a style='color:#2a6edb;'>0</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>.</a><a style='color:sandybrown;'>from</a><a style='color:red;'>)</a><div>
</div><a>        </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Enum</a><a style='color:red;'>.</a><a style='color:sandybrown;'>uniq</a><div>
</div><a>        </a><a style='color:red;'>|></a><a> </a><a style='color:gold;'>Enum</a><a style='color:red;'>.</a><a style='color:sandybrown;'>each</a><a style='color:red;'>(</a><a style='color:violet;'>fn</a><a> </a><a style='color:sandybrown;'>recipient_id</a><a> </a><a style='color:red;'>-</a><a style='color:red;'>></a><div>
</div><a>          </a><a style='color:gold;'>PubSub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>broadcast</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"chat:"</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>recipient_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>{</a><div>
</div><a>            </a><a style='color:#2a6edb;'>operator:</a><a> </a><a style='color:greenyellow;'>"chat:send"</a><a style='color:red;'>,</a><div>
</div><a>            </a><a style='color:#2a6edb;'>payload:</a><a> </a><a style='color:sandybrown;'>payload</a><div>
</div><a>          </a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>        </a><a style='color:violet;'>end</a><a style='color:red;'>)</a><div>
</div><a>    </a><a style='color:violet;'>end</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'>#############################################################################</a><div>
</div><a>  </a><a style='color:grey;'>## delete message</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'># it seems like this doesn't need to be here, but, we are sending this</a><div>
</div><a>  </a><a style='color:grey;'># through the chat room for two reasons.</a><div>
</div><a>  </a><a style='color:grey;'># - because the chat room genserver is single-threaded it will make sure that</a><div>
</div><a>  </a><a style='color:grey;'>#   the messages are well-ordered for everyone.</a><div>
</div><a>  </a><a style='color:grey;'># - eventually when the chat message logs are taken, we'll be able to</a><div>
</div><a>  </a><a style='color:grey;'>#   add soft-deletion of messages into the message logs.</a><div>
</div><a>  </a><a style='color:red;'>@</a><a style='color:sandybrown;'>spec</a><a> </a><a style='color:sandybrown;'>delete_message</a><a style='color:red;'>(</a><a style='color:gold;'>UUID</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:gold;'>Delete</a><a style='color:red;'>.</a><a style='color:sandybrown;'>t</a><a style='color:red;'>(</a><a style='color:red;'>)</a><a style='color:red;'>)</a><a> </a><a style='color:aquamarine;'>::</a><a> </a><a style='color:aquamarine;'>:ok</a><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>delete_message</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>deletion</a><a> </a><a style='color:red;'>=</a><a> </a><a style='color:red;'>%</a><a style='color:gold;'>Delete</a><a style='color:red;'>{</a><a style='color:red;'>}</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>cast</a><a style='color:red;'>(</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:delete_message</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>deletion</a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:sandybrown;'>defp</a><a> </a><a style='color:sandybrown;'>delete_message_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>deletion</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:gold;'>PubSub</a><a style='color:red;'>.</a><a style='color:sandybrown;'>broadcast</a><a style='color:red;'>(</a><a style='color:greenyellow;'>"chat:"</a><a> </a><a style='color:red;'><></a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>.</a><a style='color:sandybrown;'>room_id</a><a style='color:red;'>,</a><a> </a><a style='color:red;'>%</a><a style='color:gold;'>Broth</a><a style='color:red;'>.</a><a style='color:gold;'>Message</a><a style='color:red;'>{</a><div>
</div><a>      </a><a style='color:#2a6edb;'>operator:</a><a> </a><a style='color:greenyellow;'>"chat:delete"</a><a style='color:red;'>,</a><div>
</div><a>      </a><a style='color:#2a6edb;'>payload:</a><a> </a><a style='color:sandybrown;'>deletion</a><div>
</div><a>    </a><a style='color:red;'>}</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>    </a><a style='color:red;'>{</a><a style='color:aquamarine;'>:noreply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>}</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:grey;'>#############################################################################</a><div>
</div><a>  </a><a style='color:grey;'>## ROUTER</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_call</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:banned?</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>who</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>banned_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>who</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_call</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:get</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>get_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>reply</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set_can_chat</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>set_can_chat_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set_room_creator_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>id</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>set_room_creator_id_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set_chat_throttle</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a> </a><a style='color:violet;'>do</a><div>
</div><a>    </a><a style='color:sandybrown;'>set_chat_throttle_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>value</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a>  </a><a style='color:violet;'>end</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:set</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>set_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>key</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>value</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:unban_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>unban_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:remove_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>remove_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:add_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>add_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:send_msg</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>message</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>send_msg_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>message</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:delete_message</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>payload</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>delete_message_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>payload</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><div>
</div><a>  </a><a style='color:violet;'>def</a><a> </a><a style='color:sandybrown;'>handle_cast</a><a style='color:red;'>(</a><a style='color:red;'>{</a><a style='color:aquamarine;'>:ban_user</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>}</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><a style='color:red;'>,</a><a> </a><a style='color:#2a6edb;'>do:</a><a> </a><a style='color:sandybrown;'>ban_user_impl</a><a style='color:red;'>(</a><a style='color:sandybrown;'>user_id</a><a style='color:red;'>,</a><a> </a><a style='color:sandybrown;'>state</a><a style='color:red;'>)</a><div>
</div><a style='color:violet;'>end</a></code></html>